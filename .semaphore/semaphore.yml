version: v1.0
name: coursely
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Setup
    task:
      prologue:
        commands:
          - checkout
      jobs:
        - name: Ruby
          commands:
            - export RUBY_VERSION=$(cat .ruby-version)
            - cd ~
            - cache restore ruby-$RUBY_VERSION
            - rbenv install -s $RUBY_VERSION
            - cache store ruby-$RUBY_VERSION .rbenv/versions/$RUBY_VERSION
  - name: Install
    task:
      prologue:
        commands:
          - checkout
          - export RUBY_VERSION=$(cat .ruby-version)
          - cd ~ && cache restore ruby-$RUBY_VERSION && cd -
          - sem-version ruby $RUBY_VERSION
          - gem install bundler --no-rdoc --no-ri
      jobs:
        - name: Bundle
          commands:
            - cache restore bundler-$(checksum Gemfile.lock)
            - bundle install --deployment
            - cache store bundler-$(checksum Gemfile.lock) vendor/bundle
  - name: Tests
    task:
      env_vars:
        - name: BUNDLE_PATH
          value: vendor/bundle
      secrets:
        - name: rails-master-key
      prologue:
        commands:
          - checkout
          - export RUBY_VERSION=$(cat .ruby-version)
          - cd ~ && cache restore ruby-$RUBY_VERSEION && cd -
          - sem-version ruby $RUBY_VERSION
          - cache restore bundler-$(checksum Gemfile.lock)
          - sem-service start postgres
          - sem-service start redis
          - bin/rails db:setup
      jobs:
        - name: RSpec
          commands:
            - bin/rspec
