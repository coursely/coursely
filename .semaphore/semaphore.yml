version: v1.0
name: coursely
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Install
    task:
      prologue:
        commands:
          - checkout
          - rbenv install
          - sem-version ruby $(cat .ruby-version)
      jobs:
        - name: Bundle
          commands:
            - cache restore bundler-$(checksum Gemfile.lock)
            - bundle install --deployment
            - cache store bundler-$(checksum Gemfile.lock) vendor/bundle
  - name: Tests
    task:
      env_vars:
        - name: BUNDLE_PATH
          value: vendor/bundle
      secrets:
        - name: rails-master-key
      prologue:
        commands:
          - checkout
          - rbenv install
          - sem-version ruby $(cat .ruby-version)
          - cache restore bundler-$(checksum Gemfile.lock)
          - sem-service start postgres
          - sem-service start redis
          - bin/rails db:setup
      jobs:
        - name: RSpec
          commands:
            - bin/rspec
